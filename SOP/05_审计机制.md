# 紫微智控 - 审计机制规范

## 机制概述

**代码审计员** (T-03) 负责执行审计机制，确保交付质量。

| 项目 | 规格 |
|------|------|
| **审查维度** | 逻辑、法律、主题、落地（四维） |
| **重做上限** | 20 次 |
| **简报发送** | 审计结束即时发送康纳 |
| **模型** | bailian/qwen3-coder-next |

---

## 四维审查标准

### 一、逻辑审查

**目标**: 确保代码逻辑自洽、无技术缺陷

| 检查项 | 说明 | 通过标准 |
|--------|------|---------|
| **死循环检测** | 检查循环结构 | 所有循环有明确退出条件 |
| **变量作用域** | 检查变量定义与使用 | 无未定义变量，无作用域冲突 |
| **错误处理** | 检查异常捕获 | 关键操作有 try-catch/错误处理 |
| **边界条件** | 检查极端情况 | 空值、零值、极大值有处理 |
| **代码规范** | 检查命名与结构 | 符合语言规范，可读性良好 |

### 二、法律审查

**目标**: 确保无侵权、合规风险

| 检查项 | 说明 | 通过标准 |
|--------|------|---------|
| **开源协议** | 检查引用代码的协议 | 无 GPL 等传染性协议冲突 |
| **版权侵权** | 检查代码原创性 | 无直接复制他人代码 |
| **敏感内容** | 检查涉政/色情/暴力 | 符合阿里百炼合规要求 |
| **隐私保护** | 检查数据处理 | 无硬编码密码/密钥 |
| **商标使用** | 检查品牌名称 | 无未授权商标使用 |

### 三、主题审查

**目标**: 确保实现全部需求

| 检查项 | 说明 | 通过标准 |
|--------|------|---------|
| **功能完整** | 对比需求文档 | 所有功能点已实现 |
| **用户体验** | 检查交互设计 | 操作流畅，提示清晰 |
| **界面美观** | 检查 UI 设计 | 布局合理，视觉一致 |
| **性能优化** | 检查执行效率 | 无明显性能瓶颈 |
| **可扩展性** | 检查代码结构 | 便于后续功能扩展 |

### 四、落地审查

**目标**: 确保可实际运行

| 检查项 | 说明 | 通过标准 |
|--------|------|---------|
| **依赖明确** | 检查 package.json/requirements.txt | 所有依赖已列出 |
| **部署文档** | 检查 README | 部署步骤清晰完整 |
| **测试覆盖** | 检查测试用例 | 核心功能有测试 |
| **环境兼容** | 检查系统要求 | 明确支持的操作系统/版本 |
| **实际运行** | 抽样测试 | 代码可成功运行 |

---

## 审计工作流程

```
┌─────────────────────────────────────────────────────────┐
│                      审计工作流程                        │
└─────────────────────────────────────────────────────────┘

1. T-02 提交代码 + 审计请求
       ↓
2. T-03 接收，记录审计开始时间
       ↓
3. 执行逻辑审查 → 记录结果
       ↓
4. 执行法律审查 → 记录结果
       ↓
5. 执行主题审查 → 记录结果
       ↓
6. 执行落地审查 → 记录结果
       ↓
7. 汇总结果，做出决定（通过/驳回）
       ↓
8. 生成《审计简报》
       ↓
9. 通信官立即发送邮件给康纳
       ↓
10. 记录官归档审计报告
```

---

## 重做机制

### 重做计数规则

| 次数范围 | 状态 | 处理 |
|---------|------|------|
| 1-10 次 | 正常迭代 | 返回 T-02 修复，继续循环 |
| 11-18 次 | 升级预警 | T-01 首席架构师介入分析原因 |
| 19-20 次 | 严重警告 | 邮件康纳预警，考虑更换方案 |
| >20 次 | 熔断 | 停止任务，等待人工指令 |

### 计数器存储

**文件**: `data/tasks/[任务 ID]_audit_count.md`

```markdown
## 审计重做计数
- **任务 ID**: TASK-20250227-001
- **当前次数**: 3/20
- **历史记录**:
  - 第 1 次：缺少错误处理 → 驳回
  - 第 2 次：CSS 兼容性问题 → 驳回
  - 第 3 次：通过
- **累计耗时**: 2 小时 30 分钟
```

### 常见驳回原因

| 原因 | 占比 | 预防措施 |
|------|------|---------|
| 逻辑错误 | 35% | T-02 自检清单 |
| 需求遗漏 | 25% | 需求对照表 |
| 代码规范 | 20% | Lint 工具预检 |
| 性能问题 | 15% | 性能测试 |
| 其他 | 5% | - |

---

## 审计简报

### 触发条件
- 审计完成（通过或驳回）
- **立即发送**，不得延迟

### 简报模板

```markdown
---
主题：【审计简报】[任务名称] - [通过/驳回第 N 次]
收件人：康纳 <19922307306@189.cn>
抄送：Martin <pandac00@163.com>
---

康纳：

[任务名称] 已完成审计，结果如下。

## 审计信息
- **任务 ID**: [TASK-XXX]
- **审计员**: T-03 代码审计员
- **审查周期**: [开始时间] - [结束时间]
- **审计结果**: ✓ 通过 / ✗ 驳回（第 N 次）
- **重做计数**: N/20

## 四维审查详情

### 逻辑审查
- [✓/✗] 状态：通过/发现问题
- **说明**: [具体问题或通过说明]

### 法律审查
- [✓/✗] 状态：通过/发现问题
- **说明**: [具体问题或通过说明]

### 主题审查
- [✓/✗] 状态：通过/发现问题
- **说明**: [具体问题或通过说明]

### 落地审查
- [✓/✗] 状态：通过/发现问题
- **说明**: [具体问题或通过说明]

## 发现问题（如有）
1. [问题 1 描述]
2. [问题 2 描述]

## 修改建议（如驳回）
1. [建议 1]
2. [建议 2]

## 下一步
- [如通过]: 准备交付邮件
- [如驳回]: 返回 T-02 修复，预计 [时间] 后重新审计

---
紫微智控 代码审计员
```

---

## 审计报告归档

### 报告结构

**文件**: `data/logs/auditor_report_[任务 ID].md`

```markdown
# 审计报告

## 基本信息
- **任务 ID**: [TASK-XXX]
- **任务名称**: [名称]
- **审计员**: T-03 代码审计员
- **审计时间**: [开始] - [结束]
- **审计版本**: [第 N 次]

## 审查过程记录

### 逻辑审查
- **开始时间**: [时间]
- **检查项**:
  - [ ] 死循环检测
  - [ ] 变量作用域
  - [ ] 错误处理
  - [ ] 边界条件
  - [ ] 代码规范
- **发现问题**: [列表]
- **结论**: 通过/驳回

### 法律审查
- **开始时间**: [时间]
- **检查项**:
  - [ ] 开源协议
  - [ ] 版权侵权
  - [ ] 敏感内容
  - [ ] 隐私保护
  - [ ] 商标使用
- **发现问题**: [列表]
- **结论**: 通过/驳回

### 主题审查
- **开始时间**: [时间]
- **检查项**:
  - [ ] 功能完整
  - [ ] 用户体验
  - [ ] 界面美观
  - [ ] 性能优化
  - [ ] 可扩展性
- **发现问题**: [列表]
- **结论**: 通过/驳回

### 落地审查
- **开始时间**: [时间]
- **检查项**:
  - [ ] 依赖明确
  - [ ] 部署文档
  - [ ] 测试覆盖
  - [ ] 环境兼容
  - [ ] 实际运行
- **发现问题**: [列表]
- **结论**: 通过/驳回

## 最终结论
- **结果**: 通过 / 驳回
- **理由**: [详细说明]
- **重做计数**: N/20

## 附件
- [代码文件链接]
- [测试报告链接]
```

---

## 与巡查机制的区别

| 维度 | 进度监工 | 审计长 |
|------|---------|--------|
| **执行者** | T-04（兼任） | T-03（专职） |
| **频率** | 每 18 分钟巡查，每 4 小时简报 | 每次审计结束即时 |
| **关注点** | 过程、进度、微观逻辑 | 结果、合规、宏观落地 |
| **触发** | 定时自动 | 代码提交后 |
| **权力** | 预警、建议 | 通过/驳回（20 次限制） |
| **邮件** | 《巡查简报》 | 《审计简报》 |

---

## 审计 Prompt 模板

### 系统提示词
```
你是紫微智控的代码审计员 (T-03)，负责对代码特种兵 (T-02) 提交的代码进行四维审查。

请严格按照以下维度进行检查：
1. 逻辑审查：死循环、变量作用域、错误处理、边界条件、代码规范
2. 法律审查：开源协议、版权侵权、敏感内容、隐私保护、商标使用
3. 主题审查：功能完整、用户体验、界面美观、性能优化、可扩展性
4. 落地审查：依赖明确、部署文档、测试覆盖、环境兼容、实际运行

对于每个维度，请：
- 列出检查项
- 标记通过/发现问题
- 详细说明问题（如有）

最后给出明确结论：通过 或 驳回（第 N 次）

如果驳回，请提供具体的修改建议。
```

### 用户输入
```
## 任务信息
- **任务 ID**: [TASK-XXX]
- **任务名称**: [名称]
- **需求文档**: [链接或内容]

## 提交代码
[代码内容]

## 自测报告
[T-02 的自测结果]

## 当前重做次数
N/20
```

---

**版本**: 1.0  
**最后更新**: 2025-02-27  
**状态**: 生效中
