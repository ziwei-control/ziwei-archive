# 紫微智控 - 工作流程全景图

## 流程总览

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           紫微智控工作流程                                │
└──────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
    │ 1.任务  │ →  │ 2.执行  │ →  │ 3.质检  │ →  │ 4.交付  │ →  │ 5.归档  │
    │   接入  │    │  与监控  │    │  与审计  │    │         │    │  与学习  │
    └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
         │              │              │              │              │
         ▼              ▼              ▼              ▼              ▼
    记录官创建     监工 18 分钟      审计长四维      通信官发      通信官 GitHub
    日志，协调官   巡查缓存，4 小    审查，即时      交付邮件      上传（8 小时后）
    分发任务       时汇总简报      审计简报                       全员接续学习
```

---

## 阶段一：任务接入

### 触发条件
- 用户（Martin/康纳）在 Obsidian 创建任务文件
- 或通过其他渠道（邮件/消息）接收任务指令

### 参与岗位
- **记录官** (T-01 兼任): 创建日志
- **首席架构师** (T-01): 中断学习，分发任务

### 工作流程
```
1. 用户在 docs/tasks/inbox/ 创建 New_Task_[描述].md
2. 记录官检测到新任务文件
3. 记录官创建日志文件 docs/comm_logs/[日期]/task_received_[ID].md
4. 记录官更新 system_status.md 为 BUSY
5. 首席架构师中断当前学习（保存断点）
6. 首席架构师阅读任务，判断类型
7. 首席架构师决定是否需要 V-01 视觉解析
8. 首席架构师分解任务，生成子任务清单
```

### 输出文件
| 文件 | 路径 | 内容 |
|------|------|------|
| 任务日志 | `docs/comm_logs/[日期]/task_received_[ID].md` | 任务接收记录 |
| 系统状态 | `data/system_status.md` | 状态改为 BUSY |
| 任务分解 | `data/tasks/[ID]_decomposition.md` | 子任务清单 |

### 沟通日志示例
```markdown
---
发送者：记录官
接收者：首席架构师
类型：任务接入通知
时间：2025-02-27T14:30:00+08:00
关联任务：TASK-20250227-001
---

## 沟通内容
新任务已接收，请首席架构师介入分析。

任务简述：创建一个电商网站登录页面
优先级：高
截止时间：2025-02-28

## 附件
- 任务文件：docs/tasks/inbox/New_Task_LoginPage.md
```

---

## 阶段二：执行与监控

### 参与岗位
- **代码特种兵** (T-02): 代码生成
- **博士级架构师** (T-01 或 T-06): 文档撰写
- **进度监工** (T-04 兼任): 18 分钟巡查
- **记录官**: 全链路日志

### 工作流程
```
1. 首席架构师分发子任务给对应岗位
2. 代码特种兵开始编写代码
3. 进度监工每 18 分钟巡查一次：
   - 扫描 current_tasks/ 目录文件修改时间
   - 检查代码逻辑连贯性
   - 检查进度是否滞后
   - 写入巡查缓存 supervisor_buffer.log
4. 每 4 小时整合巡查记录，生成《巡查简报》
5. 通信官发送《巡查简报》邮件给康纳
6. 记录官在每个环节追加日志
```

### 巡查机制详解

#### 18 分钟巡查
| 检查项 | 检查方法 | 正常标准 |
|--------|---------|---------|
| 文件更新 | 检查文件 mtime | <18 分钟有更新 |
| 代码逻辑 | 扫描关键结构 | 无死循环/语法错误 |
| 进度对比 | 对比预估时间 | 滞后<20% |
| 资源占用 | 检查主机负载 | CPU<80%, 内存<90% |

#### 巡查缓存格式
```
[01:00] 检查代码逻辑：正常，循环结构闭合。
[01:18] 检查进度：滞后，缺少 CSS 样式导入。
[01:36] 检查内存占用：正常。
[01:54] 检查进度：已修复，继续进行中。
```

#### 4 小时汇总简报
```markdown
## 巡查简报
- **周期**: [开始时间] - [结束时间]
- **巡查次数**: [N 次]
- **关键事件**:
  - [01:18] 发现进度滞后（缺少 CSS）
  - [01:54] 问题已修复
- **当前进度**: 75%
- **风险点**: 无/ [具体风险]
- **下一步计划**: [简述]
```

### 输出文件
| 文件 | 路径 | 更新频率 |
|------|------|---------|
| 巡查缓存 | `data/logs/supervisor_buffer.log` | 每 18 分钟 |
| 巡查简报 | `data/logs/supervisor_4h_summary.md` | 每 4 小时 |
| 任务进度 | `data/tasks/[ID]_progress.md` | 实时更新 |

---

## 阶段三：质检与审计

### 参与岗位
- **代码审计员** (T-03): 四维审查
- **通信官**: 发送审计简报
- **记录官**: 记录审计过程

### 工作流程
```
1. 代码特种兵完成代码，提交审计请求
2. 代码审计员接收代码
3. 代码审计员执行四维审查：
   - 逻辑审查：代码逻辑是否自洽
   - 法律审查：是否侵权/合规
   - 主题审查：是否符合需求
   - 落地审查：是否可实际运行
4. 审计员记录每个审查步骤
5. 审计员做出决定：通过 / 驳回
6. 通信官立即发送《审计简报》邮件给康纳
7. 记录官记录审计结果
```

### 四维审查清单

#### 逻辑审查
- [ ] 代码无死循环
- [ ] 变量命名规范
- [ ] 错误处理完整
- [ ] 边界条件考虑

#### 法律审查
- [ ] 无侵权代码
- [ ] 无开源协议冲突
- [ ] 无敏感内容
- [ ] 符合阿里百炼合规要求

#### 主题审查
- [ ] 实现全部需求
- [ ] 功能完整
- [ ] 用户体验良好

#### 落地审查
- [ ] 代码可运行
- [ ] 依赖明确
- [ ] 部署文档完整
- [ ] 测试用例覆盖

### 重做机制
| 驳回次数 | 处理 |
|---------|------|
| 1-10 次 | 正常迭代，返回 T-02 修复 |
| 11-18 次 | 升级预警，T-01 介入分析 |
| 19-20 次 | 严重警告，考虑更换方案 |
| >20 次 | 熔断，邮件康纳人工介入 |

### 审计简报模板
```markdown
## 审计简报
- **任务 ID**: [TASK-XXX]
- **审查周期**: [开始] - [结束]
- **审查员**: T-03 代码审计员
- **审查结果**: 通过 / 驳回（第 N 次）

### 审查详情
- [✓] 逻辑审查：通过
- [✓] 法律审查：通过
- [✗] 主题审查：缺少移动端适配
- [✓] 落地审查：通过

### 发现问题
1. 缺少响应式设计，移动端显示异常

### 修改建议
1. 添加 CSS 媒体查询
2. 测试主流手机分辨率

### 重做计数**: 3/20
```

### 输出文件
| 文件 | 路径 |
|------|------|
| 审计报告 | `data/logs/auditor_report_[ID].md` |
| 审计简报 | 邮件发送康纳 |
| 重做计数 | `data/tasks/[ID]_audit_count.md` |

---

## 阶段四：交付

### 参与岗位
- **通信官**: 发送交付邮件
- **记录官**: 记录交付时间

### 触发条件
- 审计长最终审查通过

### 工作流程
```
1. 审计长标记任务为"通过"
2. 通信官准备交付邮件
3. 通信官发送邮件给康纳（抄送 Martin）
4. 记录官记录交付时间
5. 系统状态改为 IDLE（如无新任务）
6. 启动 8 小时归档倒计时
```

### 交付邮件模板
```markdown
主题：【任务交付】[任务名称] 已完成

康纳：

[任务名称] 已完成并通过审计，现交付。

## 任务信息
- **任务 ID**: [TASK-XXX]
- **开始时间**: [时间]
- **交付时间**: [时间]
- **总耗时**: [X 小时]
- **审计次数**: [N 次]

## 交付内容
- [文件列表]

## 使用说明
[简要说明]

## 项目位置
- 本地：/home/admin/Ziwei/projects/[任务 ID]/
- 云端：待 8 小时后上传 GitHub

紫微智控 通信官
```

### 输出文件
| 文件 | 路径 |
|------|------|
| 交付记录 | `data/logs/delivery_[ID].md` |
| 交付邮件 | 邮件发送康纳 |

---

## 阶段五：归档与学习

### 参与岗位
- **通信官**: GitHub 归档
- **记录官**: 归档记录
- **全员**: 接续学习

### 工作流程
```
1. 交付后等待 8 小时
2. 通信官检测归档时间到达
3. 通信官将项目文件夹推送到 GitHub
4. 通信官记录"已归档至云端"
5. 记录官将本次项目《复盘报告》放入知识库
6. 全员回到"自习室"，接续断点学习
```

### GitHub 归档规范
- **仓库**: 紫微智控私有仓库
- **分支**: main
- **提交信息**: `[归档] [任务 ID] [任务名称]`
- **保留策略**: 只上传，不删除本地

### 学习机制
| 项目 | 规则 |
|------|------|
| **学习频率** | 每小时轮转一次，每次 5 分钟 |
| **学习内容** | 各岗位专业知识、案例复盘 |
| **断点保存** | 任务来时保存 breakpoint.json |
| **断点续跑** | 任务完后读取 breakpoint.json 接续 |
| **学习产出** | `docs/knowledge/[岗位]_心路历程_[时间].md` |

### 输出文件
| 文件 | 路径 |
|------|------|
| 归档记录 | `data/logs/archive_[ID].md` |
| 复盘报告 | `docs/knowledge/[ID]_review.md` |
| 学习日志 | `docs/knowledge/[岗位]_心路历程_[时间].md` |

---

## 完整流程时间线示例

```
T+0min    任务接入，记录官创建日志
T+2min    首席架构师分解任务
T+5min    代码特种兵开始编码
T+18min   监工第 1 次巡查（正常）
T+36min   监工第 2 次巡查（发现滞后）
T+54min   监工第 3 次巡查（已修复）
T+60min   全员学习轮转（保存断点）
T+72min   监工第 4 次巡查（正常）
T+90min   代码完成，提交审计
T+95min   审计长完成审查（通过）
T+96min   通信官发送交付邮件
T+8h+96min 通信官执行 GitHub 归档
T+8h+100min 全员接续学习
```

---

## 流程异常处理

### 卡死处理
| 条件 | 响应 |
|------|------|
| 心跳 2 分钟未更新 | 急救员触发云端会诊 |
| 云端建议重启 | 通信官发邮件→重启→恢复 |
| 恢复完成 | 通信官发送《恢复报告》 |

### 审计超限处理
| 条件 | 响应 |
|------|------|
| 重做>10 次 | T-01 介入分析 |
| 重做>18 次 | 邮件预警康纳 |
| 重做>20 次 | 熔断，等待人工指令 |

### 合规红线处理
| 条件 | 响应 |
|------|------|
| 触发任意红线 | 立即熔断 + 邮件康纳 |
| API 调用被拒 | 分析原因，修改或更换模型 |
| 账号限流 | 降级到备用模型 |

---

**版本**: 1.0  
**最后更新**: 2025-02-27  
**状态**: 生效中
