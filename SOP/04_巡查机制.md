# 紫微智控 - 巡查机制规范

## 机制概述

**进度监工** (T-04 兼任) 负责执行巡查机制，确保任务执行过程透明、可控。

| 项目 | 规格 |
|------|------|
| **巡查频率** | 每 18 分钟一次 |
| **简报频率** | 每 4 小时一次（整合缓存） |
| **汇报对象** | 康纳 (19922307306@189.cn) |
| **静默规则** | 无任务时不发送简报 |

---

## 为什么是 18 分钟？

### 设计考量

| 因素 | 说明 |
|------|------|
| **防超时** | 2G 主机跑代码容易卡顿，18 分钟能及时发现"死循环"或"卡死"任务 |
| **高频反馈** | 避免等到最后才发现逻辑大翻车，18 分钟就能纠正一次方向 |
| **资源友好** | 轻量级文件扫描，不占用过多系统资源 |
| **人性化** | 康纳每 4 小时看一次总结，不用处理琐碎信息 |

---

## 巡查流程

### 每 18 分钟执行

```
┌─────────────────────────────────────────────────────────┐
│                    18 分钟巡查循环                       │
└─────────────────────────────────────────────────────────┘

1. 定时器触发
       ↓
2. 扫描 current_tasks/ 目录
       ↓
3. 检查文件修改时间
       ↓
4. 分析代码逻辑/进度
       ↓
5. 写入 supervisor_buffer.log
       ↓
6. 睡眠至下一个 18 分钟
```

### 检查内容

| 检查项 | 检查方法 | 正常标准 | 异常处理 |
|--------|---------|---------|---------|
| **文件更新** | 检查文件 mtime | <18 分钟有更新 | 标记"疑似卡死" |
| **代码逻辑** | 扫描关键结构 | 无死循环/语法错误 | 记录问题详情 |
| **进度对比** | 对比预估时间 | 滞后<20% | 标记"进度滞后" |
| **资源占用** | 检查主机负载 | CPU<80%, 内存<90% | 触发预警 |

### 巡查缓存格式

**文件**: `data/logs/supervisor_buffer.log`

```
[2025-02-27T14:00:00+08:00] 检查代码逻辑：正常，循环结构闭合。进度：25%
[2025-02-27T14:18:00+08:00] 检查进度：滞后，缺少 CSS 样式导入。进度：40%（预估 50%）
[2025-02-27T14:36:00+08:00] 检查内存占用：正常 (65%)。进度：55%
[2025-02-27T14:54:00+08:00] 检查进度：已修复 CSS，继续进行中。进度：70%
[2025-02-27T15:12:00+08:00] 检查代码逻辑：正常，无新发现问题。进度：85%
```

---

## 4 小时汇总简报

### 触发条件
- 距离上次简报 ≥ 4 小时
- supervisor_buffer.log 有新记录

### 静默规则
- **无任务时**: supervisor_buffer.log 为空，不发送简报
- **有任务时**: 必须发送，不得跳过

### 生成流程
```
1. 读取 supervisor_buffer.log 过去 4 小时记录
2. 整合提炼为结构化简报
3. 调用通信官发送邮件给康纳
4. 清空过去 4 小时的缓存记录（保留历史归档）
5. 记录简报发送日志
```

### 简报模板

```markdown
---
主题：[巡查简报] 项目进度监控报告 (周期：[开始] - [结束])
收件人：康纳 <19922307306@189.cn>
抄送：Martin <pandac00@163.com>
---

康纳：

以下是紫微智控系统过去 4 小时的巡查汇总报告。

## 周期总览
- **开始时间**: [YYYY-MM-DD HH:MM]
- **结束时间**: [YYYY-MM-DD HH:MM]
- **巡查次数**: [N 次]
- **关联任务**: [任务 ID/名称]

## 关键巡查记录

### [时间点 1]
- **事件**: 检测到代码循环结构
- **结果**: 正常闭合，无死循环风险
- **进度**: 25%

### [时间点 2]
- **事件**: 检查进度节点
- **结果**: 发现滞后，缺少样式导入（已标记）
- **进度**: 40%（预估 50%）

### [时间点 3]
- **事件**: 内存占用扫描
- **结果**: 正常，无溢出风险 (65%)
- **进度**: 55%

### [时间点 4]
- **事件**: 进度复查
- **结果**: CSS 问题已修复，继续进行中
- **进度**: 70%

## 周期总结
整体进度 [中等/良好/滞后]，存在 [N] 处风险点：
1. [风险描述]（已解决/待处理）

## 下一步计划
- [简述后续工作重点]

---
紫微智控 进度监工
```

---

## 与审计长的区别

| 维度 | 进度监工 | 审计长 |
|------|---------|--------|
| **频率** | 每 18 分钟巡查，每 4 小时简报 | 每次审计结束即时 |
| **关注点** | 过程、进度、微观逻辑 | 结果、合规、宏观落地 |
| **触发** | 定时自动 | 代码提交后 |
| **输出** | 《巡查简报》 | 《审计简报》 |
| **权力** | 预警、建议 | 通过/驳回（20 次限制） |

---

## 异常情况处理

### 疑似卡死
| 条件 | 响应 |
|------|------|
| 文件>18 分钟未更新 | 记录"疑似卡死"，继续观察 |
| 文件>36 分钟未更新 | 标记"高度疑似"，通知 T-01 |
| 文件>2 小时未更新 | 触发急救机制 |

### 进度严重滞后
| 条件 | 响应 |
|------|------|
| 滞后 20-40% | 记录，简报中说明 |
| 滞后 40-60% | 简报中标红预警 |
| 滞后>60% | 即时邮件康纳 |

### 资源过载
| 条件 | 响应 |
|------|------|
| CPU>80% | 记录，观察 |
| CPU>90% | 预警，建议暂停非关键任务 |
| 内存>90% | 紧急预警，考虑重启 |

---

## 巡查日志存储

### 文件结构
```
data/logs/
├── supervisor_buffer.log         # 当前缓存（滚动）
├── supervisor_4h_summary/        # 历史简报归档
│   ├── 2025-02-27_00-00_04-00.md
│   ├── 2025-02-27_04-00_08-00.md
│   └── ...
└── supervisor_alerts.log         # 预警记录
```

### 归档策略
- **缓存**: 保留最近 4 小时记录
- **简报**: 永久归档，按日期组织
- **预警**: 单独记录，便于复盘

---

## 与急救机制联动

### 触发条件
巡查中发现以下情况，触发急救机制：

| 条件 | 阈值 |
|------|------|
| 心跳文件未更新 | >2 分钟 |
| 任务文件未更新 | >2 小时 |
| 内存占用 | >95% |
| CPU 持续满载 | >30 分钟 |

### 联动流程
```
巡查发现异常
    ↓
标记"紧急"
    ↓
通知急救员
    ↓
急救员触发云端会诊
    ↓
执行修复方案
    ↓
巡查继续
```

---

## 脚本实现要点

### 伪代码
```python
#!/usr/bin/env python3
# supervisor.py - 进度监工巡查脚本

import os
import time
from datetime import datetime, timedelta

BUFFER_LOG = "data/logs/supervisor_buffer.log"
TASKS_DIR = "data/tasks/current/"

def check_tasks():
    """扫描任务目录，检查进度"""
    records = []
    for task_file in os.listdir(TASKS_DIR):
        mtime = os.path.getmtime(os.path.join(TASKS_DIR, task_file))
        elapsed = datetime.now() - datetime.fromtimestamp(mtime)
        
        if elapsed > timedelta(minutes=18):
            records.append(f"[{datetime.now().isoformat()}] 警告：{task_file} 超过 18 分钟未更新")
        else:
            records.append(f"[{datetime.now().isoformat()}] 正常：{task_file} 进行中")
    
    return records

def write_buffer(records):
    """写入巡查缓存"""
    with open(BUFFER_LOG, "a") as f:
        for record in records:
            f.write(record + "\n")

def should_send_summary():
    """判断是否应该发送 4 小时简报"""
    # 检查距离上次简报是否≥4 小时
    # 检查缓存是否有新记录
    pass

def generate_summary():
    """生成 4 小时汇总简报"""
    # 读取缓存，整合为简报
    pass

def main():
    while True:
        records = check_tasks()
        write_buffer(records)
        
        if should_send_summary():
            summary = generate_summary()
            send_email(summary)  # 调用通信官
        
        time.sleep(18 * 60)  # 18 分钟

if __name__ == "__main__":
    main()
```

---

**版本**: 1.0  
**最后更新**: 2025-02-27  
**状态**: 生效中
