# 紫微智控 x402 API - 项目架构设计

## 项目概述

将紫微智控的 8 个 Agent 能力包装成 x402 支付的付费 API，让其他 AI 智能体通过 USDC 微付费使用。

## 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 智能体 (客户)                          │
│              (其他开发者/自动化系统)                         │
└────────────────────┬────────────────────────────────────────┘
                     │ HTTP 402 请求
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              x402 支付网关 (Gateway)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ HTTP 402     │  │ 支付验证     │  │ 访问令牌     │      │
│  │ 响应处理     │  │ (Base链)     │  │ 管理         │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │ 通过验证
                     ▼
┌─────────────────────────────────────────────────────────────┐
│            紫微智控 API 路由 (Flask)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ /api/v1/     │  │ /api/v1/     │  │ /api/v1/     │      │
│  │ code-audit   │  │ architect    │  │ translate    │      │
│  │ (T-03)       │  │ (T-01)       │  │ (T-05)       │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ /api/v1/     │  │ /api/v1/     │  │ /api/v1/     │      │
│  │ long-text    │  │ code-gen     │  │ logic        │      │
│  │ (T-06)       │  │ (T-02)       │  │ (T-04)       │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└────────────────────┬────────────────────────────────────────┘
                     │ 调用
                     ▼
┌─────────────────────────────────────────────────────────────┐
│              阿里百炼 API (云服务)                            │
│         T-01 到 T-07 模型调用 + T-07 网络爬虫                │
└─────────────────────────────────────────────────────────────┘
```

## API 端点设计

| 端点 | Agent | 功能 | 价格 | 请求限制 |
|------|-------|------|------|---------|
| `POST /api/v1/architect` | T-01 | 架构设计 | $0.10 | 100/分钟 |
| `POST /api/v1/code-gen` | T-02 | 代码生成 | $0.08 | 200/分钟 |
| `POST /api/v1/code-audit` | T-03 | 代码审计 | $0.05 | 300/分钟 |
| `POST /api/v1/logic` | T-04 | 逻辑推理 | $0.06 | 200/分钟 |
| `POST /api/v1/translate` | T-05 | 跨域翻译 | $0.02 | 500/分钟 |
| `POST /api/v1/long-text` | T-06 | 长文解析 | $0.03 | 400/分钟 |
| `POST /api/v1/crawl` | T-07 | 网络爬虫 | $0.04 | 300/分钟 |
| `POST /api/v1/vision` | V-01 | 视觉解析 | $0.15 | 10/分钟 |

## x402 支付流程

```python
# 1. AI 智能体发送请求
POST /api/v1/code-audit
Headers: x-payment-method: x402

# 2. 服务器返回 HTTP 402 + 支付信息
HTTP 402 Payment Required
{
  "x402": {
    "amount": "0.05",
    "currency": "USDC",
    "wallet": "0x...",
    "facilitator": "https://x402.coinbase.com"
  },
  "request_id": "..."
}

# 3. AI 智能体完成 USDC 支付（ERC-3009 无 gas 转账）
# 4. AI 智能体重发请求 + 支付证明
POST /api/v1/code-audit
Headers:
  x-payment-method: x402
  x-payment-proof: "base64_encoded_payment"

# 5. 服务器验证支付 + 返回结果
HTTP 200 OK
{
  "result": "...",
  "cost": 0.05,
  "balance": 0.0
}
```

## 收入统计

```
假设每天调用次数：
- T-01 架构设计: 50 次 × $0.10 = $5.00
- T-02 代码生成: 200 次 × $0.08 = $16.00
- T-03 代码审计: 300 次 × $0.05 = $15.00
- T-04 逻辑推理: 100 次 × $0.06 = $6.00
- T-05 翻译: 500 次 × $0.02 = $10.00
- T-06 长文: 200 次 × $0.03 = $6.00
- T-07 爬虫: 100 次 × $0.04 = $4.00
- V-01 视觉: 10 次 × $0.15 = $1.50

日收入: $63.50
月收入: $1,905.00
年收入: $22,860.00
```

## 文件结构

```
/home/admin/Ziwei/projects/x402-api/
├── app.py                    # Flask 主应用
├── x402_gateway.py           # x402 支付网关
├── ziwei_agents.py           # 紫微智控 Agent 包装
├── config.py                 # 配置文件
├── requirements.txt          # Python 依赖
├── README.md                 # 文档
├── docs/
│   ├── api-reference.md     # API 文档
│   ├── payment-flow.md      # 支付流程
│   └── examples/            # 使用示例
└── data/
    ├── payments.json         # 支付记录
    └── stats.json            # 统计数据
```

## 开发阶段

### 阶段 1：x402 支付网关（3 小时）
- [ ] HTTP 402 响应处理
- [ ] USDC 支付验证（Base 链）
- [ ] 支付记录存储

### 阶段 2：紫微智控 API 路由（4 小时）
- [ ] 8 个 Agent 端点
- [ ] 阿里百炼 API 集成
- [ ] 请求限流

### 阶段 3：测试 + 部署（2 小时）
- [ ] 单元测试
- [ ] 集成测试
- [ ] 部署到服务器

### 阶段 4：文档 + 推广（3 小时）
- [ ] API 文档
- [ ] 使用示例
- [ ] GitHub 发布

**总计: 12 小时 = 1-2 天**