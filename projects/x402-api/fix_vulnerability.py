#!/usr/bin/env python3
# ä¿®å¤ä¸¥é‡å®‰å…¨æ¼æ´
import json
import base64
import urllib.request

def fix_security_vulnerability():
    """ä½¿ç”¨ AI ä¿®å¤ä»£ç å®‰å…¨æ¼æ´"""

    # åŸå§‹æ¼æ´ä»£ç 
    vulnerable_code = """def insecure():
    user_input = input("è¯·è¾“å…¥å‘½ä»¤ï¼š")
    exec(user_input)"""

    # æ„å»ºä¿®å¤è¯·æ±‚
    request_data = {
        "code": vulnerable_code,
        "language": "Python",
        "task": "fix_security"  # æ–°å¢ä»»åŠ¡ç±»å‹
    }

    # åˆ›å»ºæ”¯ä»˜è¯æ˜
    import hashlib
    unique_id = hashlib.sha256(json.dumps(request_data).encode()).hexdigest()[:16]

    proof = {
        "tx_hash": "0x" + unique_id + "a" * (64 - len(unique_id) - 1),
        "amount": "0.05",
        "sender": "0x" + unique_id + "b" * (40 - len(unique_id) - 1),
        "recipient": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
        "timestamp": "2026-03-02T19:45:00"
    }
    proof_b64 = base64.b64encode(json.dumps(proof).encode()).decode()

    # è°ƒç”¨ API
    url = "http://localhost:5002/api/v1/code-audit"
    payload = json.dumps(request_data).encode('utf-8')

    req = urllib.request.Request(
        url,
        data=payload,
        headers={
            "Content-Type": "application/json",
            "x-payment-proof": proof_b64
        }
    )

    try:
        with urllib.request.urlopen(req, timeout=30) as response:
            result = json.loads(response.read().decode('utf-8'))

            print("=" * 70)
            print("ğŸ”§ å®‰å…¨æ¼æ´ä¿®å¤å»ºè®®")
            print("=" * 70)
            print()
            print("ğŸ“Œ åŸå§‹ä»£ç ï¼ˆæœ‰ä¸¥é‡æ¼æ´ï¼‰ï¼š")
            print("-" * 70)
            print(vulnerable_code)
            print("-" * 70)
            print()
            print(f"ğŸ’° èŠ±è´¹: ${result['cost']}")
            print(f"ğŸ¤– æ¨¡å‹: {result['model']}")
            print(f"ğŸ“Š Token: {result['tokens_used']}")
            print()
            print("ğŸ›¡ï¸ AI ä¿®å¤å»ºè®®ï¼š")
            print("=" * 70)
            print(result['result'])
            print("=" * 70)
            print()

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")


if __name__ == "__main__":
    fix_security_vulnerability()