#!/usr/bin/env python3
# =============================================================================
# x402 API - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬
# åŠŸèƒ½ï¼šä¸€é”®éƒ¨ç½²åˆ°å…¬ç½‘æœåŠ¡å™¨
# =============================================================================

import os
import sys
import subprocess
import signal
from datetime import datetime

# é…ç½®
PROJECT_DIR = "/home/admin/Ziwei/projects/x402-api"
APP_FILE = "app_production.py"
PORT = 5002
PID_FILE = f"{PROJECT_DIR}/api.pid"
LOG_FILE = f"{PROJECT_DIR}/api.log"

class Deployer:
    """éƒ¨ç½²å™¨"""

    def __init__(self):
        self.project_dir = PROJECT_DIR
        self.app_file = APP_FILE
        self.port = PORT
        self.pid_file = PID_FILE
        self.log_file = LOG_FILE

    def stop_service(self):
        """åœæ­¢æœåŠ¡"""
        if os.path.exists(self.pid_file):
            with open(self.pid_file, 'r') as f:
                pid = int(f.read().strip())
            
            try:
                os.kill(pid, signal.SIGTERM)
                print(f"âœ… æœåŠ¡å·²åœæ­¢ (PID: {pid})")
                os.remove(self.pid_file)
            except ProcessLookupError:
                print(f"âš ï¸  è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ¸…ç† PID æ–‡ä»¶")
                os.remove(self.pid_file)
        else:
            print("â„¹ï¸  æœåŠ¡æœªè¿è¡Œ")

    def start_service(self):
        """å¯åŠ¨æœåŠ¡"""
        # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
        try:
            import socket
            with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                s.bind(('', self.port))
        except OSError:
            print(f"âŒ ç«¯å£ {self.port} å·²è¢«å ç”¨ï¼Œè¯·å…ˆåœæ­¢æ—§æœåŠ¡")
            return False

        # å¯åŠ¨æœåŠ¡
        cmd = f"cd {self.project_dir} && nohup python3 {self.app_file} > {self.log_file} 2>&1 &"
        process = subprocess.Popen(cmd, shell=True)
        
        # ä¿å­˜ PID
        with open(self.pid_file, 'w') as f:
            f.write(str(process.pid))
        
        print(f"âœ… æœåŠ¡å·²å¯åŠ¨ (PID: {process.pid})")
        print(f"ğŸ“ æœåŠ¡åœ°å€: http://0.0.0.0:{self.port}")
        print(f"ğŸ“„ æ—¥å¿—æ–‡ä»¶: {self.log_file}")
        return True

    def restart_service(self):
        """é‡å¯æœåŠ¡"""
        print("ğŸ”„ é‡å¯æœåŠ¡...")
        self.stop_service()
        import time
        time.sleep(2)
        return self.start_service()

    def check_status(self):
        """æ£€æŸ¥çŠ¶æ€"""
        if os.path.exists(self.pid_file):
            with open(self.pid_file, 'r') as f:
                pid = int(f.read().strip())
            
            try:
                os.kill(pid, 0)  # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
                print(f"âœ… æœåŠ¡è¿è¡Œä¸­ (PID: {pid})")
                print(f"ğŸ“ è®¿é—®åœ°å€: http://0.0.0.0:{self.port}")
                print(f"ğŸ“Š å¥åº·æ£€æŸ¥: http://0.0.0.0:{self.port}/health")
                return True
            except ProcessLookupError:
                print("âŒ è¿›ç¨‹ä¸å­˜åœ¨ï¼Œéœ€è¦å¯åŠ¨æœåŠ¡")
                return False
        else:
            print("âŒ æœåŠ¡æœªè¿è¡Œ")
            return False

    def show_logs(self):
        """æ˜¾ç¤ºæ—¥å¿—"""
        if os.path.exists(self.log_file):
            print(f"ğŸ“„ æœ€è¿‘ 50 è¡Œæ—¥å¿— ({self.log_file}):")
            print("-" * 70)
            result = subprocess.run(
                ['tail', '-n', '50', self.log_file],
                capture_output=True,
                text=True
            )
            print(result.stdout)
        else:
            print("âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨")

    def test_api(self):
        """æµ‹è¯• API"""
        import urllib.request
        import json
        
        try:
            # å¥åº·æ£€æŸ¥
            url = f"http://localhost:{self.port}/health"
            response = urllib.request.urlopen(url, timeout=5)
            health = json.loads(response.read().decode('utf-8'))
            
            print(f"âœ… å¥åº·æ£€æŸ¥: {health['status']}")
            print(f"   ç‰ˆæœ¬: {health['version']}")
            print(f"   API Key: {'å·²é…ç½®' if health.get('api_key_configured') else 'æœªé…ç½®'}")
            print(f"   æ¨¡å¼: {health.get('mode', 'unknown')}")
            
            return True
        except Exception as e:
            print(f"âŒ API æµ‹è¯•å¤±è´¥: {e}")
            return False

def main():
    """ä¸»å‡½æ•°"""
    print("=" * 70)
    print("ğŸš€ x402 API - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å·¥å…·")
    print("=" * 70)
    print()

    deployer = Deployer()

    if len(sys.argv) < 2:
        print("ç”¨æ³•:")
        print("  python deploy.py start    - å¯åŠ¨æœåŠ¡")
        print("  python deploy.py stop     - åœæ­¢æœåŠ¡")
        print("  python deploy.py restart  - é‡å¯æœåŠ¡")
        print("  python deploy.py status   - æ£€æŸ¥çŠ¶æ€")
        print("  python deploy.py logs     - æŸ¥çœ‹æ—¥å¿—")
        print("  python deploy.py test     - æµ‹è¯• API")
        print()
        print("å½“å‰çŠ¶æ€:")
        deployer.check_status()
        print()
        return

    command = sys.argv[1].lower()

    if command == 'start':
        deployer.start_service()
    elif command == 'stop':
        deployer.stop_service()
    elif command == 'restart':
        deployer.restart_service()
    elif command == 'status':
        deployer.check_status()
    elif command == 'logs':
        deployer.show_logs()
    elif command == 'test':
        deployer.test_api()
    else:
        print(f"âŒ æœªçŸ¥å‘½ä»¤: {command}")

if __name__ == "__main__":
    main()