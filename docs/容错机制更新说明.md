# 紫微智控 · 容错机制更新说明

> 所有脚本已同步更新，支持容错机制

---

## ✅ 更新完成

所有脚本已更新为容错模式，**不会因一个平台失败而阻塞流程**！

---

## 📋 已更新的脚本

### 1. sync-to-both.sh（双平台同步）

**更新内容**:
- ✅ 移除 `set -e`（不因错误退出）
- ✅ 添加超时保护（30 秒）
- ✅ 失败记录到日志
- ✅ 部分成功也返回成功码

**行为变化**:
```
旧：GitHub 失败 → 终止流程 ❌
新：GitHub 失败 → 记录失败 → 继续执行 ✅
```

---

### 2. run-task.sh（一键启动任务）

**更新内容**:
- ✅ 移除 `set -e`（不因错误退出）
- ✅ 推送超时保护（30 秒）
- ✅ 失败不阻塞后续步骤
- ✅ 同步调用使用 `|| true`

**行为变化**:
```
旧：推送失败 → 任务无法启动 ❌
新：推送失败 → 任务继续启动 → 定时重试 ✅
```

---

### 3. setup-cron.sh（Cron 配置）

**更新内容**:
- ✅ 添加每 10 分钟失败重试任务
- ✅ 更新注释说明容错机制

**新增 Cron 任务**:
```bash
# 每 10 分钟重试失败的同步
*/10 * * * * bash retry-failed-sync.sh
```

---

### 4. retry-failed-sync.sh（失败重试）

**新增脚本**:
- ✅ 检查失败记录
- ✅ 自动重试失败的同步
- ✅ 成功后清理失败日志

---

## 🎯 容错机制工作原理

### 同步流程

```
开始同步
    ↓
推送到 GitHub → 失败？→ 记录失败 → 继续 ✅
    ↓
推送到 Gitee  → 失败？→ 记录失败 → 继续 ✅
    ↓
生成报告（即使部分失败）
    ↓
流程继续，不阻塞 ✅
```

### 重试机制

```
失败记录
    ↓
每 10 分钟检查
    ↓
自动重试
    ↓
成功？→ 清除记录 ✅
失败？→ 保留记录，下次重试
```

---

## 📊 状态对比

| 情况 | 旧行为 | 新行为（容错） |
|------|--------|---------------|
| GitHub✅ + Gitee✅ | 继续 | ✅ 继续 |
| GitHub✅ + Gitee❌ | **阻塞** | ✅ **继续**，10 分钟后重试 |
| GitHub❌ + Gitee✅ | **阻塞** | ✅ **继续**，10 分钟后重试 |
| GitHub❌ + Gitee❌ | **阻塞** | ✅ **继续**，10 分钟后重试 |

---

## 🔧 使用示例

### 示例 1: 一键启动任务

```bash
bash scripts/run-task.sh TASK-20250227-001 "计算器项目" "Python 命令行计算器"
```

**输出示例**:
```
[步骤 5/6] 推送到双平台...
  ✓ GitHub 推送成功
  ! Gitee 推送失败（将继续，稍后重试）
✓ 步骤 5 完成：已尝试推送到双平台（容错）

[步骤 6/6] 启动紫微智控处理流程...
  ✓ 同步已触发（容错模式）

✅ 任务启动完成！
⚠️  部分平台失败，将在下次定时同步重试
```

**结果**: 任务正常启动，Gitee 会在 10 分钟后自动重试 ✅

---

### 示例 2: 手动同步

```bash
bash scripts/sync-to-both.sh
```

**输出示例**:
```
[3/5] 推送到 GitHub...
  ✓ GitHub 推送成功

[4/5] 推送到 Gitee...
  ! Gitee 推送失败（将继续执行，稍后重试）

[5/5] 生成同步报告...
状态：部分成功（已继续执行）

✅ 同步完成（容错模式）
```

**结果**: 同步完成，不阻塞流程 ✅

---

## 📝 失败记录

### 记录位置

```
/home/admin/Ziwei/data/logs/sync_failures.log
```

### 查看失败记录

```bash
cat data/logs/sync_failures.log
```

### 手动重试

```bash
bash scripts/retry-failed-sync.sh
```

---

## 🔍 监控命令

### 查看同步状态

```bash
# 查看最新同步报告
ls -lt data/logs/sync_report_*.md | head -1 | xargs cat
```

### 查看失败记录

```bash
cat data/logs/sync_failures.log
```

### 查看 Cron 日志

```bash
# 巡查日志
tail -f data/logs/cron_watchdog.log

# 重试日志
tail -f data/logs/cron_retry.log

# 每日同步日志
tail -f data/logs/cron_daily_sync.log
```

---

## ⚙️ 配置检查

### 验证 Cron 配置

```bash
cat /etc/cron.d/ziwei-sync
```

**应该包含**:
```bash
# 每 30 分钟巡查
*/30 * * * * python3 auto-sync-watchdog.py

# 每 10 分钟重试
*/10 * * * * bash retry-failed-sync.sh

# 每日 23:40 强制同步
40 23 * * * bash sync-to-both.sh
```

### 验证脚本权限

```bash
ls -la scripts/*.sh
```

**应该都有 `x` 权限**:
```
-rwxr-xr-x scripts/run-task.sh
-rwxr-xr-x scripts/sync-to-both.sh
-rwxr-xr-x scripts/retry-failed-sync.sh
```

---

## 🎯 最佳实践

### 1. 启动任务后检查状态

```bash
# 启动任务
bash scripts/run-task.sh TASK-XXX "名称" "描述"

# 检查同步状态
ls -lt data/logs/sync_report_*.md | head -1 | xargs cat
```

### 2. 定期检查失败记录

```bash
# 每天查看一次
cat data/logs/sync_failures.log
```

### 3. 手动重试（如需要）

```bash
bash scripts/retry-failed-sync.sh
```

### 4. 监控任务进度

```bash
cat data/system_status.md
```

---

## 📋 常见问题

### Q1: 脚本还能正常使用吗？

**A**: ✅ **完全可以！** 所有脚本已更新为容错模式，功能更强大。

### Q2: 之前的任务会受影响吗？

**A**: ✅ **不会！** 容错机制只影响新任务，旧任务继续正常运行。

### Q3: 需要重新配置吗？

**A**: ✅ **已自动配置！** Cron 任务已更新，无需手动操作。

### Q4: 如何确认容错机制生效？

**A**: 运行一次同步，故意制造失败（如断网），观察输出：
```bash
bash scripts/sync-to-both.sh
# 应该显示"部分成功"而不是"失败退出"
```

---

## 🔗 相关文档

- [[容错同步机制]] - 详细说明
- [[一键启动任务指南]] - 任务启动
- [[自动同步功能说明]] - 巡查和定时同步
- [[双平台同步说明]] - 同步功能

---

## ✅ 总结

| 脚本 | 状态 | 容错支持 |
|------|------|---------|
| **run-task.sh** | ✅ 已更新 | ✅ 支持 |
| **sync-to-both.sh** | ✅ 已更新 | ✅ 支持 |
| **retry-failed-sync.sh** | ✅ 新增 | ✅ 支持 |
| **setup-cron.sh** | ✅ 已更新 | ✅ 支持 |
| **auto-sync-watchdog.py** | ✅ 已修复 | ✅ 支持 |

**所有脚本已同步更新，可以正常使用！** 🚀
