# 紫微智控 · 工作流程图

> 从任务创建到交付的完整流程

---

## 完整工作流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        紫微智控工作流程全景图                            │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐
│  1. 创建任务  │
│  (Obsidian)  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  在 Obsidian 中：                                                         │
│  1. 打开 /home/admin/Ziwei/docs/                                         │
│  2. 使用任务模板创建笔记                                                 │
│  3. 保存到 data/tasks/inbox/                                             │
│  4. 命名：TASK-日期 - 序号_任务名称.md                                     │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  2. 任务接入  │
│  (自动检测)  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  本地监控脚本 (local_monitor.py)：                                        │
│  - 每 10 秒扫描 inbox 文件夹                                                 │
│  - 发现新任务文件                                                          │
│  - 更新心跳文件                                                            │
│  - 通知 T-01 首席架构师                                                     │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  3. 任务分解  │
│  (T-01 负责)  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  T-01 首席架构师：                                                         │
│  1. 阅读任务需求                                                          │
│  2. 判断是否需要 V-01 视觉解析                                              │
│  3. 分解为子任务                                                           │
│  4. 生成任务分解报告                                                       │
│  5. 分发给对应岗位                                                         │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  4. 任务执行  │
│  (多岗位协作)│
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  并行/串行执行：                                                           │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                         │
│  │ T-02 代码    │  │ T-06 长文    │  │ T-07 网络    │                         │
│  │ 特种兵      │  │ 解析器      │  │ 爬虫        │                         │
│  │ 生成代码    │  │ 处理文档    │  │ 搜索信息    │                         │
│  └──────┬─────┘  └──────┬─────┘  └──────┬─────┘                         │
│         │               │               │                                 │
│         └───────────────┼───────────────┘                                 │
│                         ▼                                                 │
│                ┌─────────────────┐                                        │
│                │ T-04 进度监工     │                                        │
│                │ 每 18 分钟巡查一次   │                                        │
│                │ 写入巡查缓存      │                                        │
│                └─────────────────┘                                        │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  5. 代码审计  │
│  (T-03 负责)  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  T-03 代码审计员：                                                         │
│  1. 接收 T-02 提交的代码                                                    │
│  2. 执行四维审查：                                                         │
│     - 逻辑审查 ✓                                                         │
│     - 法律审查 ✓                                                         │
│     - 主题审查 ✓                                                         │
│     - 落地审查 ✓                                                         │
│  3. 做出决定：                                                            │
│     - 通过 → 进入交付环节                                                 │
│     - 驳回 → 返回 T-02 修复 (计数+1，最多 20 次)                                │
│  4. 发送《审计简报》邮件给康纳                                              │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  6. 任务交付  │
│  (通信官负责)│
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  通信官 (courier.py)：                                                    │
│  1. 准备交付邮件                                                          │
│  2. 包含任务信息、交付内容、使用说明                                       │
│  3. 发送给康纳 (抄送 Martin)                                                │
│  4. 记录交付日志                                                          │
│  5. 启动 8 小时归档倒计时                                                    │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  7. 项目归档  │
│  (8 小时后)    │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  通信官执行归档：                                                          │
│  1. 等待 8 小时                                                              │
│  2. 调用自动评分系统                                                       │
│  3. 根据评分分类：                                                         │
│     - S/A 级 (90+) → PENDING_RELEASE (待发布变现)                           │
│     - B 级 (70-89) → ARCHIVE (历史存档)                                     │
│     - C 级 (<70) → FAILED_CANDIDATES                                      │
│  4. 推送到 GitHub 仓库                                                      │
│  5. 记录归档日志                                                           │
│  6. 本地文件保留（不删除）                                                  │
└──────────────────────────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────┐
│  8. 全员学习  │
│  (接续断点)  │
└──────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────────────────────────┐
│  全员"自习课"：                                                           │
│  1. 读取断点文件 (breakpoint.json)                                        │
│  2. 接续未完成的学习                                                       │
│  3. 记录心路历程                                                          │
│  4. 每小时轮转 5 分钟                                                        │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 关键机制

### 18 分钟巡查机制

```
时间线：
00:00 → 巡查 #1 → 写入缓存
00:18 → 巡查 #2 → 写入缓存
00:36 → 巡查 #3 → 写入缓存
00:54 → 巡查 #4 → 写入缓存
01:00 → 生成 4 小时简报 → 邮件康纳 → 清空缓存
```

### 审计重做机制

```
第 1 次驳回 → 返回 T-02 修复
第 2 次驳回 → 返回 T-02 修复
...
第 10 次驳回 → T-01 介入分析
...
第 19 次驳回 → 邮件预警康纳
第 20 次驳回 → 熔断，等待人工指令
```

### 急救机制

```
心跳超时 (>2 分钟)
    ↓
生成 emergency.flag
    ↓
云端会诊 (qwen3.5-plus)
    ↓
诊断结果：无需重启 → 执行修复方案 → 继续运行
诊断结果：需要重启 → 邮件警报 → 重启 → 恢复任务
```

---

## 岗位协作关系

```
                    ┌─────────────────┐
                    │  T-01 首席架构师  │
                    │  (总调度中心)    │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
┌───────────────┐  ┌───────────────┐  ┌───────────────┐
│ V-01 视觉侦察兵 │  │ T-02 代码特种兵 │  │ T-07 网络爬虫  │
│ (图像解析)     │  │ (代码生成)     │  │ (联网搜索)    │
└───────┬───────┘  └───────┬───────┘  └───────┬───────┘
        │                  │                  │
        └──────────────────┼──────────────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │ T-03 代码审计员  │
                  │ (四维审查)       │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │   通信官        │
                  │ (邮件通知)       │
                  └─────────────────┘
```

---

## 邮件通知时机

| 邮件类型 | 触发条件 | 发送者 | 频率 |
|---------|---------|--------|------|
| 巡查简报 | 任务执行中 | 进度监工 | 每 4 小时 |
| 审计简报 | 审计结束 | 审计长 | 即时 |
| 交付邮件 | 任务通过 | 通信官 | 1 次/项目 |
| 警报邮件 | 系统卡死/违规 | 急救员 | 即时 |
| 恢复报告 | 重启完成 | 通信官 | 即时 |
| 学习简报 | 空闲学习期 | 记录官 | 每 4 小时 |

---

## 文件流转路径

```
Obsidian (任务创建)
    ↓
data/tasks/inbox/ (待处理)
    ↓
data/tasks/current/ (进行中)
    ↓
projects/ (已完成)
    ↓
repo_archive/SUCCESS/ (归档)
    ↓
GitHub (云端备份)
```

---

**这就是紫微智控的完整工作流程！** 🎯
